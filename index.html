<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Chemical Annotator</title>
    <style>
        /* --- CSS Variables for Theming --- */
        :root {
            /* Color Palette */
            --primary-color: #3498db;
            --primary-hover: #2980b9;
            --secondary-color: #2ecc71;
            --secondary-hover: #27ae60;
            --tertiary-color: #f39c12;
            --tertiary-hover: #d35400;
            --danger-color: #e74c3c;
            --danger-hover: #c0392b;
            --disabled-color: #bdc3c7;

            /* Light Theme Variables (Default) */
            --bg-color: #f4f7f9;
            --surface-color: #ffffff;
            --text-color: #333333;
            --text-color-light: #555555;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --smiles-bg-color: #eeeeee;
            --smiles-bg-hover: #dddddd;
            --link-color: #2980b9;
        }

        /* --- Dark Theme Variables (Applied via .dark-theme class) --- */
        body.dark-theme {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --text-color: #e0e0e0;
            --text-color-light: #bbbbbb;
            --border-color: #444444;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --smiles-bg-color: #333333;
            --smiles-bg-hover: #444444;
            --link-color: #5dade2;
            --disabled-color: #555;
        }

        /* --- General Styles --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--surface-color);
            box-shadow: 0 4px 8px var(--shadow-color);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        /* --- Top Controls --- */
        .top-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .file-ops, .mode-switcher {
            display: flex;
            gap: 15px; /* Increased gap for theme toggle */
            align-items: center;
            flex-wrap: wrap;
        }

        /* --- Theme Toggle Button --- */
        #theme-toggle-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            color: var(--text-color);
        }
        #theme-toggle-btn:hover {
            background-color: var(--smiles-bg-color);
        }
        #theme-toggle-btn svg {
            width: 18px;
            height: 18px;
        }
        /* Logic to show the correct icon based on theme */
        .sun-icon { display: none; }
        body.dark-theme .moon-icon { display: none; }
        body.dark-theme .sun-icon { display: block; }


        /* --- Buttons and Inputs --- */
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-secondary:hover { background-color: var(--secondary-hover); }
        .btn-tertiary { background-color: var(--tertiary-color); color: white; }
        .btn-tertiary:hover { background-color: var(--tertiary-hover); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: var(--danger-hover); }
        .btn-small { padding: 4px 8px; font-size: 12px; }
        .btn:disabled { background-color: var(--disabled-color); cursor: not-allowed; }

        input[type="text"], input[type="number"] {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--surface-color);
            color: var(--text-color);
        }
        body.dark-theme input[type="text"], body.dark-theme input[type="number"] {
            background-color: #2c2c2c;
        }

        /* --- Edit Mode --- */
        #edit-mode-container { display: flex; gap: 20px; }
        .pdf-viewer { flex: 3; border: 1px solid var(--border-color); padding: 10px; border-radius: 5px; min-width: 0; }
        .pdf-nav { display: flex; justify-content: center; align-items: center; margin-bottom: 10px; gap: 10px; flex-wrap: wrap; }
        .page-input { width: 60px; text-align: center; }
        .page-render-wrapper { position: relative; margin: 0 auto; max-width: 100%; }
        .page-render-wrapper canvas { max-width: 100%; height: auto; display: block; }
        body.dark-theme .page-render-wrapper canvas { filter: invert(0.9) hue-rotate(180deg); }
        .textLayer { position: absolute; left: 0; top: 0; right: 0; bottom: 0; line-height: 1.0; }
        .textLayer > span { color: transparent; position: absolute; white-space: pre; cursor: text; transform-origin: 0% 0%; }
        .annotations-panel { flex: 2; border: 1px solid var(--border-color); padding: 20px; border-radius: 5px; min-width: 0; }
        .annotation-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .annotation-panel-header h3 { margin: 0; font-size: 1.1em; }
        .annotation-form { display: flex; flex-direction: column; gap: 10px; }
        #annotations-list { max-height: 65vh; overflow-y: auto; }
        .annotation-item { border: 1px solid var(--border-color); border-radius: 5px; padding: 15px; margin-bottom: 10px; background-color: var(--surface-color); }
        .annotation-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .annotation-item-header h4 { margin: 0; }
        .annotation-item-header h4 a { color: var(--link-color); text-decoration: none; }
        .annotation-item-header h4 a:hover { text-decoration: underline; }
        .annotation-item-controls { display: flex; gap: 5px; }
        .annotation-item p { margin: 5px 0; word-break: break-all; color: var(--text-color-light); }
        .annotation-item p strong { color: var(--text-color); }
        .structure-svg svg { width: 100%; height: auto; }

        /* --- View Mode --- */
        #view-mode-container { display: none; }
        .page-container { display: flex; gap: 20px; margin-bottom: 25px; padding-bottom: 25px; border-bottom: 2px dashed var(--border-color); }
        .page-container:last-child { border-bottom: none; }
        .pdf-render-target { flex: 3; min-width: 0; }
        .view-mode-annotations { flex: 2; min-width: 0; }
        .view-mode-annotations h3 { margin-top: 0; }
        .annotations-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .compact-annotation { font-size: 0.9em; border: 1px solid var(--border-color); padding: 10px; border-radius: 4px; }
        .compact-annotation h4 { margin: 0 0 2px 0; line-height: 1.2; }
        .compact-annotation h4 a { color: var(--link-color); text-decoration: none; }
        .compact-annotation h4 a:hover { text-decoration: underline; }
        .compact-annotation p { margin: 2px 0; line-height: 1.2; color: var(--text-color-light); }
        .compact-annotation p strong { color: var(--text-color); }
        .compact-annotation .structure-svg svg { max-width: 200px; margin-top: 5px; }
        .smiles-copy { cursor: pointer; font-family: monospace; background-color: var(--smiles-bg-color); padding: 2px 4px; border-radius: 3px; }
        .smiles-copy:hover { background-color: var(--smiles-bg-hover); }

        #loader { font-size: 1.2em; text-align: center; padding: 20px; }

        /* --- Responsive Design --- */
        @media (max-width: 1200px) {
            #edit-mode-container, .page-container { flex-direction: column; }
            .annotations-panel { margin-top: 20px; }
        }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 15px; }
            .top-controls { flex-direction: column; align-items: stretch; }
            .file-ops { justify-content: center; }
            .mode-switcher { justify-content: space-between; } /* Align items to ends */
            .btn { font-size: 14px; padding: 8px 12px; }
        }
    </style>
    <!-- PDF.js & RDKit.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://unpkg.com/@rdkit/rdkit/dist/RDKit_minimal.js"></script>
</head>
<body>
    <div class="container">
        <div class="top-controls">
            <div class="file-ops">
                <input type="file" id="pdf-file" accept=".pdf">
                <button id="load-json-btn" class="btn btn-tertiary" disabled>Load JSON</button>
                <input type="file" id="json-file-input" accept=".json" style="display: none;">
                <button id="save-json-btn" class="btn btn-secondary" disabled>Save JSON</button>
            </div>
            <div class="mode-switcher">
                <div>
                    <strong>Mode:</strong>
                    <label><input type="radio" name="mode" value="edit" checked> Edit</label>
                    <label><input type="radio" name="mode" value="view"> View</label>
                </div>
                <button id="theme-toggle-btn" title="Toggle theme">
                    <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.106a.75.75 0 010 1.06l-1.591 1.59a.75.75 0 11-1.06-1.06l1.59-1.59a.75.75 0 011.06 0zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.894 17.894a.75.75 0 01-1.06 0l-1.59-1.591a.75.75 0 111.06-1.06l1.59 1.59a.75.75 0 010 1.06zM12 18a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM5.106 17.894a.75.75 0 010-1.06l1.59-1.59a.75.75 0 111.06 1.06l-1.59 1.59a.75.75 0 01-1.06 0zM3 12a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H3.75A.75.75 0 013 12zM6.106 5.106a.75.75 0 011.06 0l1.59 1.591a.75.75 0 11-1.06 1.06l-1.59-1.59a.75.75 0 010-1.06z"></path></svg>
                    <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69.75.75 0 01.981.98 10.503 10.503 0 01-9.694 6.46c-5.799 0-10.5-4.701-10.5-10.5 0-3.864 2.09-7.171 5.197-8.92a.75.75 0 01.818.162z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
        </div>
        <div id="loader">Waiting for RDKit.js to load...</div>
        <div id="edit-mode-container" style="display: none;">
            <div class="pdf-viewer">
                <div class="pdf-nav">
                    <button id="prev-page" class="btn btn-primary">&lt; Prev</button>
                    <span>Page: <span id="page-num"></span> / <span id="page-count"></span></span>
                    <input type="number" id="page-input" class="page-input" min="1">
                    <button id="go-to-page-btn" class="btn btn-primary btn-small">Go</button>
                    <button id="next-page" class="btn btn-primary">Next &gt;</button>
                </div>
                <div id="edit-page-render-target" class="page-render-wrapper"></div>
            </div>
            <div class="annotations-panel">
                <div class="annotation-panel-header">
                    <h3>Annotations for page <span id="annotation-page-num"></span></h3>
                    <div id="form-buttons">
                        <button id="add-update-btn" class="btn btn-primary">Add Molecule</button>
                        <button id="cancel-edit-btn" class="btn btn-danger" style="display: none;">Cancel</button>
                    </div>
                </div>
                <div class="annotation-form">
                    <input type="text" id="name-en" placeholder="Name (EN), e.g., Benzene">
                    <input type="text" id="name-ru" placeholder="Name (RU), e.g., Бензол">
                    <input type="text" id="smiles" placeholder="SMILES, e.g., c1ccccc1">
                    <input type="text" id="cid" placeholder="PubChem CID, e.g., 241">
                </div>
                <div id="annotations-list"></div>
            </div>
        </div>
        <div id="view-mode-container"></div>
    </div>

    <script>
        // --- Theme Switching Logic ---
        const themeToggleBtn = document.getElementById('theme-toggle-btn');

        // Function to apply the theme
        const applyTheme = (theme) => {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme');
            }
        };

        // On page load, check for saved theme or system preference
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme) {
                applyTheme(savedTheme);
            } else if (prefersDark) {
                applyTheme('dark');
            }
        });

        // Event listener for the toggle button
        themeToggleBtn.addEventListener('click', () => {
            const isDark = document.body.classList.contains('dark-theme');
            if (isDark) {
                applyTheme('light');
                localStorage.setItem('theme', 'light');
            } else {
                applyTheme('dark');
                localStorage.setItem('theme', 'dark');
            }
        });


        // --- Global State ---
        let pdfDoc = null;          // The loaded PDF document object from PDF.js
        let pageNum = 1;            // Current page number being viewed/edited
        let rdkit = null;           // The RDKit module instance
        let annotations = {};       // Main object to store all annotations, keyed by page number
        let currentMode = 'edit';   // Tracks the current UI mode ('edit' or 'view')
        let viewModeRendered = false; // Flag to avoid re-rendering all pages in view mode unnecessarily
        let editingIndex = null;    // Index of the annotation being edited, or null if none
        const scale = 1.5;          // Scale for rendering PDF pages

        // --- DOM Element References ---
        const loader = document.getElementById('loader');
        const editModeContainer = document.getElementById('edit-mode-container');
        const viewModeContainer = document.getElementById('view-mode-container');
        const saveBtn = document.getElementById('save-json-btn');
        const loadBtn = document.getElementById('load-json-btn');
        const jsonFileInput = document.getElementById('json-file-input');
        const addUpdateBtn = document.getElementById('add-update-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const annotationsList = document.getElementById('annotations-list');
        const pageInput = document.getElementById('page-input');
        const goToPageBtn = document.getElementById('go-to-page-btn');

        // --- Initialization ---
        // Load the RDKit module. This is an asynchronous operation.
        window.initRDKitModule().then(function (RDKit) {
            rdkit = RDKit;
            console.log("RDKit version: " + RDKit.version());
            loader.textContent = "Please select a PDF file to begin.";
        }).catch(function () {
            loader.textContent = "Error loading RDKit.js. Please check your internet connection.";
        });

        // --- PDF Rendering Logic ---

        /**
         * Updates the scale of the text layer to match the rendered canvas.
         * This is crucial for responsive text selection.
         * @param {HTMLElement} container The container holding the canvas and text layer.
         */
        function updateTextLayerScale(container) {
            if (!container._pdfViewport) return;

            const canvas = container.querySelector('canvas');
            const textLayer = container.querySelector('.textLayer');
            if (!canvas || !textLayer) return;

            const actualWidth = canvas.clientWidth;
            const originalWidth = container._pdfViewport.width;
            const scale = actualWidth / originalWidth;

            textLayer.style.transform = `scale(${scale})`;
            textLayer.style.transformOrigin = '0 0';
        }

        /**
         * Renders a single PDF page to a target container, including a selectable text layer.
         * @param {number} num The page number to render.
         * @param {HTMLElement} targetContainer The container element to render into.
         */
        async function renderPage(num, targetContainer) {
            const page = await pdfDoc.getPage(num);
            const viewport = page.getViewport({ scale: scale });

            // Store the viewport on the container for later scale calculations
            targetContainer._pdfViewport = viewport;

            // Prepare canvas and text layer elements
            targetContainer.innerHTML = '';
            const canvas = document.createElement('canvas');
            const textLayerDiv = document.createElement('div');
            textLayerDiv.className = 'textLayer';
            
            targetContainer.style.width = `${viewport.width}px`;
            targetContainer.style.height = `${viewport.height}px`;
            targetContainer.appendChild(canvas);
            targetContainer.appendChild(textLayerDiv);

            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({ canvasContext: context, viewport }).promise;

            const textContent = await page.getTextContent();
            await pdfjsLib.renderTextLayer({
                textContent: textContent,
                container: textLayerDiv,
                viewport: viewport,
                textDivs: []
            }).promise;

            // Update the text layer scale to match the responsive canvas
            updateTextLayerScale(targetContainer);
        }

        /**
         * Renders all pages of the PDF document sequentially for the 'View' mode.
         */
        async function renderAllPages() {
            if (viewModeRendered) {
                return; // Avoid re-rendering if already done
            }
            loader.style.display = 'block';
            viewModeContainer.innerHTML = '';

            for (let i = 1; i <= pdfDoc.numPages; i++) {
                loader.textContent = `Rendering pages (${i}/${pdfDoc.numPages})...`;
                
                const pageContainer = document.createElement('div');
                pageContainer.className = 'page-container';
                const renderTarget = document.createElement('div');
                renderTarget.className = 'pdf-render-target page-render-wrapper';
                const annotationsTarget = document.createElement('div');
                annotationsTarget.className = 'view-mode-annotations';

                pageContainer.appendChild(renderTarget);
                pageContainer.appendChild(annotationsTarget);
                viewModeContainer.appendChild(pageContainer);

                await renderPage(i, renderTarget);
                displayAnnotationsForPage(i, annotationsTarget, 'compact');
            }
            viewModeRendered = true;
            loader.style.display = 'none';
        }

        // --- Annotation Management ---

        /**
         * Displays annotations for a given page in the specified container and mode.
         * @param {number} num The page number.
         * @param {HTMLElement} container The element to display annotations in.
         * @param {string} displayMode 'full' for edit mode, 'compact' for view mode.
         */
        function displayAnnotationsForPage(num, container, displayMode = 'full') {
            container.innerHTML = '';
            const pageAnnotations = annotations[num] || [];

            if (displayMode === 'compact') {
                container.innerHTML = `<h3>Page ${num}</h3>`;
            }

            if (pageAnnotations.length === 0) {
                container.innerHTML += '<p>No annotations for this page.</p>';
                return;
            }
            
            const annotationsContainer = (displayMode === 'compact') ? document.createElement('div') : container;
            if (displayMode === 'compact') {
                annotationsContainer.className = 'annotations-grid';
            }

            pageAnnotations.forEach((item, index) => {
                const mol = rdkit.get_mol(item.smiles);
                if (!mol) return; // Skip if SMILES is invalid

                const svg = mol.get_svg();
                mol.delete(); // IMPORTANT: Free up memory used by the RDKit molecule object

                const wikiLink = `https://en.wikipedia.org/wiki/${encodeURIComponent(item.name_en.replace(/ /g, '_'))}`;
                const pubchemLink = `https://pubchem.ncbi.nlm.nih.gov/compound/${item.cid}`;
                const itemDiv = document.createElement('div');
                
                if (displayMode === 'full') {
                    itemDiv.className = 'annotation-item';
                    itemDiv.innerHTML = `
                        <div class="annotation-item-header">
                            <h4><a href="${wikiLink}" target="_blank" rel="noopener noreferrer">${item.name_en}</a></h4>
                            <div class="annotation-item-controls">
                                <button class="btn btn-small btn-primary btn-edit" data-index="${index}">Edit</button>
                                <button class="btn btn-small btn-danger btn-delete" data-index="${index}">Delete</button>
                            </div>
                        </div>
                        <p><strong>RU:</strong> ${item.name_ru || ''}</p>
                        <p><strong>SMILES:</strong> ${item.smiles}</p>
                        <p><strong>PubChem:</strong> <a href="${pubchemLink}" target="_blank" rel="noopener noreferrer">${item.cid}</a></p>
                        <div class="structure-svg">${svg}</div>`;
                } else { // compact mode
                    itemDiv.className = 'compact-annotation';
                    itemDiv.innerHTML = `
                        <h4><a href="${wikiLink}" target="_blank" rel="noopener noreferrer">${item.name_en}</a> (${item.name_ru || ''})</h4>
                        <p><strong>SMILES:</strong> <span class="smiles-copy" title="Click to copy">${item.smiles}</span></p>
                        <p><strong>PubChem:</strong> <a href="${pubchemLink}" target="_blank" rel="noopener noreferrer">${item.cid}</a></p>
                        <div class="structure-svg">${svg}</div>`;
                }
                annotationsContainer.appendChild(itemDiv);
            });

            if (displayMode === 'compact') {
                container.appendChild(annotationsContainer);
            }
        }

        /**
         * Handles the logic for both adding a new molecule and updating an existing one.
         */
        function handleAddOrUpdateMolecule() {
            if (!rdkit) {
                alert("RDKit is not loaded yet.");
                return;
            }

            const name_en = document.getElementById('name-en').value.trim();
            const smiles = document.getElementById('smiles').value.trim();
            const cid = document.getElementById('cid').value.trim();
            if (!name_en || !smiles || !cid) {
                alert("Please fill in Name (EN), SMILES, and PubChem CID fields.");
                return;
            }

            const mol = rdkit.get_mol(smiles);
            if (!mol) {
                alert("Invalid SMILES string.");
                return;
            }
            mol.delete();

            const newAnnotation = {
                name_en: name_en,
                name_ru: document.getElementById('name-ru').value.trim(),
                smiles: smiles,
                cid: cid
            };

            if (editingIndex !== null) {
                annotations[pageNum][editingIndex] = newAnnotation;
            } else {
                if (!annotations[pageNum]) {
                    annotations[pageNum] = [];
                }
                annotations[pageNum].push(newAnnotation);
            }
            
            resetForm();
            displayAnnotationsForPage(pageNum, annotationsList, 'full');
            viewModeRendered = false;
        }

        /**
         * Resets the annotation form to its default state.
         */
        function resetForm() {
            document.getElementById('name-en').value = '';
            document.getElementById('name-ru').value = '';
            document.getElementById('smiles').value = '';
            document.getElementById('cid').value = '';
            
            editingIndex = null;
            addUpdateBtn.textContent = 'Add Molecule';
            addUpdateBtn.className = 'btn btn-primary';
            cancelEditBtn.style.display = 'none';
        }

        /**
         * Handles clicks on 'Edit' and 'Delete' buttons using event delegation.
         */
        function handleAnnotationActions(event) {
            const target = event.target;

            if (target.classList.contains('btn-edit')) {
                editingIndex = parseInt(target.dataset.index, 10);
                const item = annotations[pageNum][editingIndex];
                
                document.getElementById('name-en').value = item.name_en;
                document.getElementById('name-ru').value = item.name_ru;
                document.getElementById('smiles').value = item.smiles;
                document.getElementById('cid').value = item.cid;
                
                addUpdateBtn.textContent = 'Update Molecule';
                addUpdateBtn.className = 'btn btn-secondary';
                cancelEditBtn.style.display = 'inline-block';
                document.getElementById('name-en').focus();
            } 
            else if (target.classList.contains('btn-delete')) {
                const index = parseInt(target.dataset.index, 10);
                const itemToDelete = annotations[pageNum][index];
                if (confirm(`Are you sure you want to delete "${itemToDelete.name_en}"?`)) {
                    annotations[pageNum].splice(index, 1);
                    displayAnnotationsForPage(pageNum, annotationsList, 'full');
                    viewModeRendered = false;
                }
            }
        }

        /**
         * Handles clicks on SMILES strings in view mode to copy them to the clipboard.
         */
        function handleSmilesCopy(event) {
            const target = event.target;
            if (target.classList.contains('smiles-copy')) {
                navigator.clipboard.writeText(target.textContent).then(() => {
                    const originalText = target.innerHTML;
                    target.textContent = 'Copied!';
                    setTimeout(() => { target.innerHTML = originalText; }, 1000);
                }).catch(err => {
                    console.error('Failed to copy SMILES: ', err);
                });
            }
        }

        // --- File I/O ---

        function handleSaveAndDownload() {
            if (Object.keys(annotations).length === 0) {
                alert("No annotations to save.");
                return;
            }
            const jsonString = JSON.stringify(annotations, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'annotations.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function handleLoadJson(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    if (typeof loadedData !== 'object' || loadedData === null || Array.isArray(loadedData)) {
                        throw new Error("JSON file content must be an object.");
                    }
                    annotations = loadedData;
                    viewModeRendered = false;
                    alert('Annotations loaded successfully!');
                    if (currentMode === 'edit') {
                        updateEditModeUI();
                    } else {
                        renderAllPages();
                    }
                } catch (error) {
                    alert(`Error: Could not parse JSON file. ${error.message}`);
                }
            };
            reader.readAsText(file);
            event.target.value = null;
        }

        // --- UI Navigation & Control ---

        function updateEditModeUI() {
            document.getElementById('page-num').textContent = pageNum;
            document.getElementById('annotation-page-num').textContent = pageNum;
            pageInput.value = pageNum;
            renderPage(pageNum, document.getElementById('edit-page-render-target'));
            displayAnnotationsForPage(pageNum, annotationsList, 'full');
        }

        function goToPage() {
            const targetPage = parseInt(pageInput.value, 10);
            if (!isNaN(targetPage) && targetPage >= 1 && targetPage <= pdfDoc.numPages) {
                pageNum = targetPage;
                updateEditModeUI();
            } else {
                alert(`Please enter a valid page number between 1 and ${pdfDoc.numPages}.`);
                pageInput.value = pageNum;
            }
        }

        function onPrevPage() {
            if (pageNum > 1) {
                pageNum--;
                updateEditModeUI();
            }
        }

        function onNextPage() {
            if (pageNum < pdfDoc.numPages) {
                pageNum++;
                updateEditModeUI();
            }
        }

        function switchMode(newMode) {
            currentMode = newMode;
            if (newMode === 'edit') {
                viewModeContainer.style.display = 'none';
                if (pdfDoc) {
                    editModeContainer.style.display = 'flex';
                    updateEditModeUI();
                }
            } else { // view mode
                editModeContainer.style.display = 'none';
                if (pdfDoc) {
                    viewModeContainer.style.display = 'block';
                    renderAllPages();
                }
            }
        }

        // --- Event Listeners ---

        // Handles window resize to keep text layer in sync
        window.addEventListener('resize', () => {
            document.querySelectorAll('.page-render-wrapper').forEach(updateTextLayerScale);
        });

        document.getElementById('pdf-file').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file || file.type !== 'application/pdf') return;

            loader.style.display = 'block';
            loader.textContent = 'Loading PDF...';

            const fileReader = new FileReader();
            fileReader.onload = function() {
                const typedarray = new Uint8Array(this.result);
                pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;
                
                pdfjsLib.getDocument(typedarray).promise.then(function(pdfDoc_) {
                    pdfDoc = pdfDoc_;
                    
                    document.getElementById('page-count').textContent = pdfDoc.numPages;
                    pageInput.max = pdfDoc.numPages;
                    pageNum = 1;
                    annotations = {};
                    viewModeRendered = false;
                    saveBtn.disabled = false;
                    loadBtn.disabled = false;
                    loader.style.display = 'none';
                    
                    switchMode('edit');
                });
            };
            fileReader.readAsArrayBuffer(file);
        });

        document.querySelectorAll('input[name="mode"]').forEach(radio => {
            radio.addEventListener('change', (e) => switchMode(e.target.value));
        });

        loadBtn.addEventListener('click', () => jsonFileInput.click());
        jsonFileInput.addEventListener('change', handleLoadJson);
        saveBtn.addEventListener('click', handleSaveAndDownload);
        
        document.getElementById('prev-page').addEventListener('click', onPrevPage);
        document.getElementById('next-page').addEventListener('click', onNextPage);
        goToPageBtn.addEventListener('click', goToPage);
        pageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') goToPage(); });
        addUpdateBtn.addEventListener('click', handleAddOrUpdateMolecule);
        cancelEditBtn.addEventListener('click', resetForm);
        annotationsList.addEventListener('click', handleAnnotationActions);
        
        viewModeContainer.addEventListener('click', handleSmilesCopy);

    </script>
</body>
</html>